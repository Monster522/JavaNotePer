## SpringMVC中的线程安全问题

### 1.问题描述

在`Tomcat`中，通过多线程处理多个请求，每一个线程处理一个请求。在这种多线程的环境下，是否会出现线程安全问题。

### 2.分析

#### 2.1线程安全的定义

1. 线程安全本质上是竞态问题，竞态指计算的正确性依赖于相对时间顺序(`RelativeTiming`)或者线程的交错(`Interleaving`)。

2. 多个线程在没有采取任何控制措施的情况下并发地更新、读取同一个共享变量，会导致竞态。

   共享变量指的是可以被多个线程访问到的变量。共享变量包括实例变量和静态变量，变量实质上都是基本类型的值，即引用类型的存储就是指针的地址`int`。

#### 2.2SpringMVC中是否存在多线程共享变量

1. 在`Tomcat`多线程环境中，共同访问的对象有`Controller`、`Service`等。这些对象实例由`Spring`进行统一管理，一般在一个`Spring`容器中只有一个实例。所以就是**多线程共同访问对象的同一个实例**。

   JVM可以启动多个`Spring`容器，通常只有一个。`Spring`容器实质上就是一个`BeanFactory`对象，可以`new`出多个。而在`Tomcat`中，对于每一个应用通常只有一个`JVM`。所以`Tomcat`中的每一个应用通常对应着一个`Spirng`容器。

2. 是否会造成线程安全问题，取决于多线程共同访问对象中是否存在共享变量。即`Controller`、`Service`中是否存在共享变量。

3. 通常情况下，`Controller`存在引用类型变量`Service`。在`Servcie`中，往往不存在基本类型的共享变量。所以只要保证引用类型变量的指针值不发生改变，就不会发生多个线程访问共享变量的情况。

4. 在多线程访问无状态对象的情况下，不会发生线程安全的问题。

   像`Controller`、`Service`等没有存在基本类型的状态变量，但是存在不变的引用类型变量，以及每个引用类型都是无状态对象，这样可称为广义上的无状态对象。

5. 狭义上的无状态对象，指一个类中没有状态变量，即没有实例变量和静态变量，只有定义方法和局部变量。

   如果一个类的同一个实例被多个线程共享，并不会使这些线程存在共享状态(`SharedState`) , 这个类或者其任意一个实例被称为无状态对象(`StatelessObject`)。

   
   
### 2.3线程安全问题例子

1. 在并发访问的前提下，在`Controller`中访问`Service`等引用类型变量，并在处理方法中修改引用类型变量的指针值，就会引起线程安全问题。
2. 保证并发访问情况下线程安全的三个措施
   - 不改变Spring容器中单例对象变量的指针值。
   - 不定义状态变量，包括实例变量和静态变量。
   - 如果定义了状态变量，即要保证此变量为不可变，或者访问此变量是线程安全的。

   

