##进程管理

###1. 进程与线程
####1.1 进程
- **进程定义**
  1. 进程是资源分配的基本单位。
  2. 进程控制块 (Process Control Block, PCB) 描述进程的基本信息和运行状态，所谓的创建进程和撤销进程，都是指对 PCB 的操作。

- **进程并发**
  下图显示了 4 个程序创建了 4 个进程，这 4 个进程可以并发地执行。
  ![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/a6ac2b08-3861-4e85-baa8-382287bfee9f.png)

####1.2 线程
- **定义**
  1. 线程是独立调度的基本单位。
  2. 一个进程中可以有多个线程，它们共享进程资源。

- **线程并发**
  1. QQ 和浏览器是两个进程，浏览器进程里面有很多线程，例如 HTTP 请求线程、事件响应线程、渲染线程等等。
  2. 线程的并发执行使得，在浏览器中点击一个新链接从而发起 HTTP 请求时，浏览器还可以响应用户的其它事件。
![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/3cd630ea-017c-488d-ad1d-732b4efeddf5.png)

####1.3 区别
- **拥有资源**
  1. 进程是资源分配的基本单位。
  2. 线程不拥有资源，线程只可以访问隶属进程的资源。

- **调度**
  1. 线程是独立调度的基本单位，在同一进程中，线程的切换不会引起进程切换。
  2. 从一个进程中的线程切换到另一个进程中的线程时，会引起进程切换。

- **系统开销**
  1. 由于创建或撤销进程时，系统都要为之分配或回收资源，如内存空间、I/O 设备等，所付出的开销远大于创建或撤销线程时的开销。
  2. 类似地，在进行进程切换时，涉及当前执行进程 CPU 环境的保存及新调度进程 CPU 环境的设置。
  3. 而线程切换时只需保存和设置少量寄存器内容，开销很小。

- **通信方面**
  1. 线程间可以通过直接读写同一进程中的数据进行通信。
  2. 但是进程通信需要借助 IPC。

###2. 进程状态的切换
![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/ProcessState.png)

- **进程的状态**
  1. 就绪状态(`ready`)：等待被调度
  2. 运行状态(`running`)
  3. 阻塞状态(`waiting`)：等待资源

- **状态切换过程**
  1. 只有就绪态和运行态可以相互转换，其它的都是单向转换。
  2. 就绪状态的进程通过调度算法从而获得CPU时间，转为运行状态。
  3. 运行状态的进程，在分配的CPU时间片用完之后就会转为就绪状态，等待下一次调度。
  4. 阻塞状态是缺少需要的资源，从而由运行状态转换而来。但是该资源不包括CPU时间，缺少CPU时间会从运行态转换为就绪态。

###3.进程调度算法

不同环境的调度算法目标不同，因此需要针对不同环境来讨论调度算法。

####3.1批处理系统

- **系统功能**
  1. 批处理系统没有太多的用户操作，在该系统中，调度算法目标是保证吞吐量和周转时间（从提交到终止的时间）。
  2. 分为三种算法：
     - 先来先服务
     - 短作业优先
     - 最短剩余时间优先

- **先来先服务 first-come first-serverd（FCFS）** 
  1. 非抢占式的调度算法，按照请求的顺序进行调度。
  2. 有利于长作业，但不利于短作业。
  3. 因为短作业必须一直等待前面的长作业执行完毕才能执行，而长作业又需要执行很长时间，造成了短作业等待时间过长。

- **短作业优先 shortest job first（SJF）** 
  1. 非抢占式的调度算法，按估计运行时间最短的顺序进行调度。
  2. 长作业有可能会饿死，处于一直等待短作业执行完毕的状态。
  3. 因为如果一直有短作业到来，那么长作业永远得不到调度。

- **最短剩余时间优先 shortest remaining time next（SRTN）** 
  1. 最短作业优先的抢占式版本，按剩余运行时间的顺序进行调度。
  2. 当一个新的作业到达时，其整个运行时间与当前进程的剩余时间作比较。
  3. 如果新的进程需要的时间更少，则挂起当前进程，运行新的进程。否则新的进程等待。

#### 3.2交互式系统
- **系统功能**
  1. 交互式系统有大量的用户交互操作，在该系统中调度算法的目标是快速地进行响应。
  2. 分为三种算法：
     - 时间片轮转
     - 优先级调度
     - 多级反馈队列

- **时间片轮转** 
  1. 将所有就绪进程按**先来先服务(FCFS)**的原则排成一个队列。**每次调度时，把 CPU 时间分配给队首进程，该进程可以执行一个时间片**。
  2. 当时间片用完时，由计时器发出时钟中断，调度程序便停止该进程的执行。然后将它送往就绪队列的末尾，同时继续把 CPU 时间分配给队首的进程。
  3. 时间片轮转**算法的效率和时间片的大小**有很大关系：
     - 因为进程切换都要保存进程的信息并且载入新进程的信息，如果时间片太小，会导致进程切换得太频繁，在进程切换上就会花过多时间。
     - 而如果时间片过长，那么实时性就不能得到保证。
     ![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/8c662999-c16c-481c-9f40-1fdba5bc9167.png)

- **优先级调度** 
  1. 为每个进程分配一个优先级，**按优先级进行调度**。
  2. 为了防止低优先级的进程永远等不到调度，可以随着时间的推移增加等待进程的优先级。

- **多级反馈队列** 
  1. 一个进程需要执行 100 个时间片，如果采用时间片轮转调度算法，那么需要交换 100 次。
  2. 多级队列是**为这种需要连续执行多个时间片的进程**考虑。
  3. 设置了多个队列，每个队列时间片大小都不同，例如 1,2,4,8,..。进程在第一个队列没执行完，就会被移到下一个队列。这种方式下，之前的进程只需要交换 7 次。
  4. 每个队列优先权也不同，最上面的优先权最高。因此只有上一个队列没有进程在排队，才能调度当前队列上的进程。
  5. 可以将这种调度算法看成是时间片轮转调度算法和优先级调度算法的结合。
     ![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/042cf928-3c8e-4815-ae9c-f2780202c68f.png)

####2.3 实时系统
- 实时系统要求一个请求在一个确定时间内得到响应。
  1. 分为硬实时和软实时，前者必须满足绝对的截止时间，后者可以容忍一定的超时。

###3.进程同步

####3.1 临界区
- 定义
  1. 对临界资源进行访问的那段代码称为临界区。
  2. 为了互斥访问临界资源，每个进程在进入临界区之前，需要先进行检查。
     ```html
     // entry section
     // critical section;
     // exit section
     ```

####3.2 同步与互斥
- 同步
  1. 多个进程因为合作产生的直接制约关系，使得进程有一定的先后执行关系。
  
- 互斥
  1. 多个进程在同一时刻只有一个进程能进入临界区。

####3.3 信号量
- **定义**
  1. 信号量(Semaphore)是一个整型变量，可以对其执行down和up操作，也就是常见的P和V操作。

  2. **down操作**
     - 如果信号量大于0，执行-1操作。
     - 如果信号量等于0，进程睡眠，等待信号量大于0。

  3. **up操作**
     - 对信号量执行+1操作，唤醒睡眠的进程让其完成down操作。
  
  4. down和up操作需要被设计成原语，不可分割。通常的做法是在执行这些操作的时候屏蔽中断。

  5. 如果信号量的取值只能为0或者1，那么就成为了**互斥量（Mutex）**。0表示临界区已经加锁，1表示临界区解锁。


####3.4 管程
- **定义**
  1. 使用信号量机制实现的生产者消费者问题需要客户端代码做很多控制。
  2. 而管程把控制的代码独立出来，不仅不容易出错，也使得客户端代码调用更容易。

- **特性**
  1. 在一个时刻只能有一个进程使用管程。
  2. 进程在无法继续执行的时候不能一直占用管程，否则其它进程永远不能使用管程。

- **原理**
  1. 管程引入了**条件变量**以及相关的操作：**wait()** 和 **signal()** 来实现同步操作。
  2. 对条件变量执行wait()操作会导致调用进程阻塞，把管程让出来给另一个进程持有。signal() 操作用于唤醒被阻塞的进程。


###4.进程通信

####4.1进程同步和通信的区别联系
- 区别
  1. 进程同步，控制多个进程按一定顺序执行。
  2. 进程通信，进程间传输信息。

- 联系
  1. 进程通信是一种手段，而进程同步是一种目的。
  2. 为了能够达到进程同步的目的，需要让进程进行通信，传输一些进程同步所需要的信息。

- 进程通信的四种方式
  1. 管道
  2. 命名管道(FIFO)
  3. 消息队列
  4. 信号量
  5. 共享存储
  6. 套接字

####4.2管道
- 定义
  1. 管道是通过调用pipe函数创建的，fd[0]用于读，fd[1]用于写。
  2. 只支持半双工通信(单向交替传输)。
  3. 只能在父子进程或者兄弟进程中使用。
     ![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/53cd9ade-b0a6-4399-b4de-7f1fbd06cdfb.png)



####4.3FIFO
- 定义
  1. 也称为命名管道，去除了管道只能在父子进程中使用的限制。
  2. FIFO常用于客户-服务器应用程序中，FIFO用作汇聚点，在客户进程和服务器进程之间传递数据。
     ![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/2ac50b81-d92a-4401-b9ec-f2113ecc3076.png)

####4.4消息队列

- 相比于FIFO，消息队列的优点
  1. 消息队列可以独立于读写进程存在，从而避免了FIFO中同步管道的打开和关闭时可能产生的困难。
  2. 避免了 FIFO 的同步阻塞问题，不需要进程提供同步方法。
  3. 读进程可以根据消息类型有选择地接收消息，而不像FIFO那样只能默认地接收。

####4.5信号量
- 是一个计数器，用于为多个进程提供对共享数据对象的访问。

####4.6共享存储
- 定义
  1. 允许多个进程共享一个给定的存储区。因为数据不需要在进程之间复制，所以这是最快的一种 IPC。
  2. 需要使用信号量用来同步对共享存储的访问。
  3. 多个进程可以将同一个文件映射到它们的地址空间从而实现共享内存。
  4. 另外XSI共享内存不是使用文件，而是使用内存的匿名段。

####4.7套接字
- 与其它通信机制不同的是，它可用于不同机器间的进程通信。

