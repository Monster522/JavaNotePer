## Mysql基础原理

### 1.SQL执行原理

![](https://javanote.oss-cn-shenzhen.aliyuncs.com/14_SQL执行原理.png)

- **执行顺序**
  1. **from**：对左表left-table和右表right-table执行笛卡尔积(a*b)，形成虚拟表VT1。
  2. **on**: 对虚拟表VT1进行on条件进行筛选，只有符合条件的记录才会插入到虚拟表VT2中。
  3. **join**: 指定out join会将未匹配行添加到VT2产生VT3,若有多张表，则会重复(1)~(3)。
  4. **where**: 对VT3进行条件过滤，形成VT4, where条件是从左向右执行的。
  5. **group by**: 对VT4进行分组操作得到VT5。
  6. **cube | rollup**: 对VT5进行cube | rollup操作得到VT6。
  7. **having**: 对VT6进行过滤得到VT7。
  8. **select**: 执行选择操作得到VT8，本人看来VT7和VT8应该是一样的。
  9. **distinct**: 对VT8进行去重，得到VT9。
  10. **order by**: 对VT9进行排序，得到VT10。
  11. **limit**: 对记录进行截取，得到VT11返回给用户。
- **执行原理**
  1. 每一步操作都会生成一个虚拟表，作为下一个处理的输入。在这个过程中，这些虚拟表对于用户都是透明的，只用最后一步执行完的虚拟表返回给用户。在处理过程中，没有的步骤会直接跳过。
  2. on条件应用于连表过滤，where应用于on过滤后的结果(有on的话)，having应用于分组过滤。

###2.数据库的优化(sql语句优化和索引两个部分)
1. **硬件优化**，提高机器性能，增加硬件等。
2. **优化SQL查询语句**
   - 将限定性强的where条件放前。
   - 用exists代替in操作等。
   - SELECT子句中避免使用*。
   - 用Where子句替换HAVING子句。
   - 通过内部函数提高SQL效率，用EXISTS替代IN、用NOT EXISTS替代NOT IN，用WHERE替代ORDER BY。
3. **优化索引**，建立有效的索引并检查和修复缺少的统计信息等。
4. 数据库系统**文件优化**，将数据文件、索引文件、日志文件放置在不同的磁盘上，提高并行度等。将大表分割成小表。



### 3.关系型数据库和非关系型数据库区别  

####3.1关系型数据库
- **特性**
  1. 关系型数据库，是指采用了关系模型来组织数据的数据库。
  2. 关系型数据库的最大特点就是**事务的一致性**。
  3. 简单来说，关系模型指的就是二维表格模型，而一个关系型数据库就是由二维表及其之间的联系所组成的一个数据组织。

- **优点**
  1. 容易理解。二维表结构是非常贴近逻辑世界一个概念，关系模型相对网状、层次等其他模型来说更容易理解。
  2. 使用方便。通用的SQL语言使得操作关系型数据库非常方便。
  3. 易于维护。丰富的完整性(实体完整性、参照完整性和用户定义的完整性)大大减低了数据冗余和数据不一致的概率。
  4. 支持SQL，可用于复杂的查询。

- **缺点**
  1. 为了维护一致性所付出的巨大代价就是其读写性能比较差。
  2. 固定的表结构，扩展性比较差。
  3. 满足不了高并发读写需求。
  4. 海量数据的读写效率很低。

####3.2非关系型数据库
- **特性**
  1. 使用键值对存储数据。
  2. 分布式。
  3. 一般不支持ACID特性。
  4. 非关系型数据库严格上不是一种数据库，应该是一种数据结构化存储方法的集合。

- **优点**
  1. 无需经过sql层的解析，读写性能很高。
  2. 基于键值对，数据没有耦合性，容易扩展。
  3. 存储数据的格式：nosql的存储格式是key,value形式、文档形式、图片形式等等，文档形式、图片形式等等，而关系型数据库则只支持基础类型。

- **缺点**
  1. 不提供sql支持，学习和使用成本较高。
  2. 无事务处理，附加功能bi和报表等支持也不好。

###4.数据库慢查询
- **定义**
  
1. 分析MySQL语句查询性能的方法除了使用EXPLAIN输出执行计划，还可以让MySQL记录下查询超过指定时间的语句，将超过指定时间的SQL语句查询称为"慢查询"。
  
- **开启慢查询方法**
  
  ```sql
  -- 1.查询慢查询开启状态以及日志存放位置
  show variables like 'slow_query%'; 
  -- 2.查询慢查询设置的时间参数
show variables like 'long_query_time';
  
  -- 3.设置参数
  set global slow_query_log='ON';
  set global slow_query_log_file='/usr/local/mysql/data/slow.log';
set global long_query_time=1;
  
  -- 4.修改配置文件my.cnf，在[mysqld]下的下方加入、
  [mysqld]
  slow_query_log = ON
  slow_query_log_file = /usr/local/mysql/data/slow.log
long_query_time = 1
  
  -- 5.重启服务
  service mysqld restart
  ```