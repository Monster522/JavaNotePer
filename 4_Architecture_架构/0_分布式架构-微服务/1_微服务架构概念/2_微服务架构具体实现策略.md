## 微服务架构具体实现策略

### 1.微服务和SOA

- 微服务是`SOA`的一种落地方案
  1. `SOA`是一种面向服务的架构思想，微服务也同样推崇这种思想。微服务是将一个大型的单块架构，拆分为多个细粒度服务的架构。
  2. 微服务的概念相比`SOA`更容易落地的原因不是概念上的创新，而是技术上的突破，尤其是容器与自动化运维技术的普及与应用。
- 微服务必将坚持走轻量级技术路线
  1. 轻量级必须包含三个特征：易用、快速、稳定。



### 2.微服务架构的实现

![](https://javanote.oss-cn-shenzhen.aliyuncs.com/4_微服务架构的实现.png)

- 技术选型

  1. 注册中心：用于注册微服务相关配置信息的中心，ZooKeeper实现。
  2. 调用中心：用于提供给前端调用的统一入口，Node.js实现。
  3. 部署中心：用于编译并打包微服务源码并将其部署到Docker引擎中，Jenkins实现。
  4. 日志中心：用于收集并管理微服务应用程序中产生的日志，Kafka-Logstash-Elasticsearch-Kibana实现。
  5. 监控中心：用于监控微服务的实时运行状况，cAdvisor+InfluxDB+Grafana实现。
  6. 追踪中心：用于最终微服务的调用轨迹，Zipkin实现。
  7. 消息中心：用于解耦微服务之间的调用关系，变成异步调用，ActiveMQ或RabbitMQ实现。
  8. 配置中心：用于管理微服务应用程序所需的配置参数，Ansible实现。

- 切割微服务边界

  1. 梳理业务流程
  2. 抽取公共服务
  3. 定义业务服务
  4. 设计数据模型
  5. 定义服务接口

  
### 3.微服务架构的运行流程
![](https://javanote.oss-cn-shenzhen.aliyuncs.com/5_微服务架构的运行流程.png)

- 部署阶段
  1. 开发人员将源码提交并推送到代码仓库，部署中心将从代码仓库中获取源码，并执行编译与打包操作。
  2. 部署中心从配置中心获取对应运行环境的配置参数，并生成相应的配置文件。
  3. 将这些配置文件与应用程序一同复制到`Docker`镜像中，然后将此镜像上传到镜像仓库。
  4. 部署中心还可扫描源码并自动生成`API`文档站点，以便其他技术人员可随时从文档站点中查看最新部署服务所包含的`API`文档。
  5. 当`Docker`镜像上传到镜像仓库后，部署中心可在不同的运行环境下根据特定的镜像来启动相应的`Docker`容器。
  6. 当服务容器启动后，会自动将其配置信息写入注册中心。与此同时，部署中心也会连接到注册中心，并设置服务的版本号，以便于在后续调用服务时可根据版本号来识别当前可用的服务。
- 运行阶段
  1. 当用户通过浏览器或移动端访问应用系统时，请求首先将进入服务网关，也就是调用中心。
  2. 服务发现，调用中心将连接注册中心，并通过服务名称从注册中心中获取服务所在的ip地址与端口号(即服务地址)。
  3. 服务调用，调用中心可根据服务地址以反向代理的方式来调用具体的服务容器。
  4. 在服务容器中可能会触发一些事件，这些事件将以消息的方式写入消息中心，以便其他服务可监听消息中心并从中获取相应的消息。
  5. 在服务容器运行时会产生大量的日志，我们可将这些日志统一写入日志中心，并能在日志中心所提供的控制台上查询具体的日志信息。
  6. 监控中心将不断地收集服务容器中的运行状态，包括CPU、内存、硬盘、网络，以及应用程序的JVM内存使用情况。
  7. 微服务之间难免会出现少量的调用关系，将每次调用所产生的相关信息写入追踪中心，并通过追踪中心提供的图形化界面来查看服务之间的调用轨迹以及所产生的调用延时，从而可分析出服务调用所产生的性能瓶颈。

  